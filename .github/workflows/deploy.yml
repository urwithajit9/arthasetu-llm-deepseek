name: Deploy to Modal (Budget Edition)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PYTHON_VERSION: "3.11"
  MODAL_VERSION: ">=0.63.0"

jobs:
  # ============================================================================
  # PRE-DEPLOYMENT VALIDATION
  # ============================================================================
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install modal

      - name: Syntax Check
        run: |
          # Check which Modal app file exists
          if [ -f "modal_app.py" ]; then
            echo "‚úì Checking modal_app.py"
            python -m py_compile modal_app.py
          elif [ -f "modal_app_simple.py" ]; then
            echo "‚úì Checking modal_app_simple.py"
            python -m py_compile modal_app_simple.py
          elif [ -f "modal_app_budget.py" ]; then
            echo "‚úì Checking modal_app_budget.py"
            python -m py_compile modal_app_budget.py
          else
            echo "‚ùå No Modal app file found!"
            exit 1
          fi

      - name: Check Modal Configuration
        run: |
          modal --version
          python -c "import modal; print(f'Modal version: {modal.__version__}')"

  # ============================================================================
  # DEPLOY TO MODAL
  # ============================================================================
  deploy:
    name: Deploy to Modal
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.web_url }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Modal
        run: |
          python -m pip install --upgrade pip
          pip install "modal${{ env.MODAL_VERSION }}"

      - name: Verify Modal Installation
        run: |
          modal --version

      - name: Set Environment Variables
        run: |
          echo "ENVIRONMENT=${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_ENV
          echo "DEPLOY_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "GIT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

      - name: Deploy to Modal
        id: deploy
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "üöÄ Deploying Budget Edition to Modal ($ENVIRONMENT)"
          echo "üì¶ Git SHA: $GIT_SHA"
          echo "‚è∞ Deploy time: $DEPLOY_TIME"
          echo "üí∞ Target cost: <$30/month"

          # Determine which file to deploy
          if [ -f "modal_app.py" ]; then
            DEPLOY_FILE="modal_app.py"
          elif [ -f "modal_app_simple.py" ]; then
            DEPLOY_FILE="modal_app_simple.py"
          elif [ -f "modal_app_budget.py" ]; then
            DEPLOY_FILE="modal_app_budget.py"
          else
            echo "‚ùå No Modal app file found!"
            exit 1
          fi

          echo "üìÑ Deploying file: $DEPLOY_FILE"

          # Deploy with detailed output and capture exit code
          set +e  # Don't exit on error yet
          modal deploy "$DEPLOY_FILE" --yes 2>&1 | tee deploy_output.txt
          DEPLOY_EXIT_CODE=${PIPESTATUS[0]}
          set -e  # Re-enable exit on error

          # Check if deployment succeeded
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Deployment failed with exit code $DEPLOY_EXIT_CODE"
            echo "üìã Error output:"
            cat deploy_output.txt | tail -50
            exit 1
          fi

          echo "‚úÖ Deployment succeeded"

          # Extract web URL if available
          WEB_URL=$(grep -oP 'https://[^\s]+modal\.run[^\s]*' deploy_output.txt | head -1 || echo "")
          if [ -n "$WEB_URL" ]; then
            echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
            echo "‚úÖ Deployed to: $WEB_URL"
          else
            echo "‚ö†Ô∏è  Web URL not found in output"
            echo "Checking for deployment URL in different format..."
            grep -i "https://" deploy_output.txt | head -5 || echo "No URLs found"
          fi

      - name: Health Check
        if: steps.deploy.outputs.web_url != ''
        run: |
          echo "üè• Running health check..."
          sleep 15  # Wait for deployment to stabilize

          HEALTH_URL="${{ steps.deploy.outputs.web_url }}/health"

          for i in {1..5}; do
            HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed!"
              curl -s "$HEALTH_URL" | python -m json.tool || true
              exit 0
            fi

            echo "‚è≥ Attempt $i/5: HTTP $HTTP_CODE, retrying..."
            sleep 10
          done

          echo "‚ö†Ô∏è  Health check didn't return 200 after 5 attempts"
          echo "This might be normal for budget mode (cold start)"
          echo "Try manually: curl $HEALTH_URL"

      - name: Post Deployment Summary
        if: always()
        run: |
          echo "## üöÄ Budget Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Edition**: Budget (<$30/month)" >> $GITHUB_STEP_SUMMARY
          echo "- **GPU**: T4 (\$0.40/hr)" >> $GITHUB_STEP_SUMMARY
          echo "- **Warm Containers**: 0 (cold starts ~20-30s)" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA**: $GIT_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Time**: $DEPLOY_TIME" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.deploy.outputs.web_url }}" ]; then
            echo "- **URL**: ${{ steps.deploy.outputs.web_url }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí° Budget Mode Notes" >> $GITHUB_STEP_SUMMARY
          echo "- First request after idle: 20-30s (cold start)" >> $GITHUB_STEP_SUMMARY
          echo "- Subsequent requests: 1-3s (warm)" >> $GITHUB_STEP_SUMMARY
          echo "- Scales down after 60s idle" >> $GITHUB_STEP_SUMMARY
          echo "- Target usage: <75 hours/month for <\$30" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # POST-DEPLOYMENT TESTS (Optional - may fail on cold start)
  # ============================================================================
  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    continue-on-error: true  # Don't fail if tests timeout due to cold start
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Basic Test
        env:
          API_URL: ${{ needs.deploy.outputs.web_url }}
          TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
        run: |
          echo "üß™ Running basic tests (may be slow due to cold start)..."

          # Basic connectivity test
          curl -f "$API_URL/" || echo "Root endpoint check failed"

          # Health check test (with longer timeout for cold start)
          timeout 60 curl -f "$API_URL/health" || echo "Health check timed out (normal for cold start)"

          echo "‚úÖ Basic tests completed (errors expected on cold start)"

  # ============================================================================
  # COST NOTIFICATION
  # ============================================================================
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy, test]
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Budget edition deployed successfully!"
            echo ""
            echo "üí∞ Cost Optimization:"
            echo "  - GPU: T4 (\$0.40/hr)"
            echo "  - Warm containers: 0"
            echo "  - Expected: <\$30/month for light usage"
            echo ""
            echo "‚ö†Ô∏è  Important:"
            echo "  - Cold start: ~20-30s on first request"
            echo "  - Set billing alert at \$25 in Modal dashboard"
            echo "  - Monitor usage at https://modal.com/usage"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi